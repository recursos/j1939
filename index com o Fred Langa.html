<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
  <title>J1939 CAN bus spy</title>


  <meta content="text/html; charset=iso-8859-1" http-equiv="Content-Type">

  <meta name="description" content="SAE J1939 and CAN bus - RS232 spy using Microchip PIC18F4580.">

  <meta name="keywords" content="J1939, CAN bus, RS232, spy, simulation, SAE, Microchip">

  <style type="text/css">
BODY {font-family: Verdana,courier;} .myText {COLOR: #339900} .quoted {COLOR: gray} .highlite {BACKGROUND-COLOR: #ffff33} A:hover { TEXT-DECORATION: underline; FONT-WEIGHT: bold }
BODY {
background : transparent url(images/gutter_gray.png) repeat-y;
}
TD {font-size: small;font-family: Verdana,courier;} .myText {COLOR: #339900} .quoted {COLOR: gray} .highlite {BACKGROUND-COLOR: #ffff33} A:hover { TEXT-DECORATION: underline; FONT-WEIGHT: bold }
  </style>
</head>


<body>

<table width="600">

  <tbody>

    <tr>

      <td>
      <pre>Last Updated 2006-May-05</pre>

      <h3>J1939.c
CAN Bus plus RS232</h3>

<!-- zm_cda_common_display_ziffsplash : start -->
      <script language="javascript">
// Set slideShowSpeed (milliseconds)
var slideShowSpeed = 3000
// Duration of crossfade (seconds)
var crossFadeDuration = 3
// Specify the image files
var Pic = new Array() // don't touch this
// to add more images, just continue
// the pattern, adding to the array below
Pic[0] = 'http://common.ziffdavisinternet.com/util_get_image/13/0,1425,i=134534,00.jpg'
Pic[1] = 'http://common.ziffdavisinternet.com/util_get_image/13/0,1425,i=134540,00.jpg'
Pic[2] = 'http://common.ziffdavisinternet.com/util_get_image/13/0,1425,i=134541,00.jpg'
Pic[3] = 'http://common.ziffdavisinternet.com/util_get_image/13/0,1425,i=134535,00.jpg'
// =======================================
// do not edit anything below this line
// =======================================
var t
var j = 0
var p = Pic.length
var preLoad = new Array()
for (i = 0; i < p; i++){
preLoad[i] = new Image()
preLoad[i].src = Pic[i]
}
function runSlideShow(){
if (document.all){
document.images.SlideShow.style.filter='blendTrans(duration=2)'
document.images.SlideShow.style.filter='blendTrans(duration=crossFadeDuration)'
document.images.SlideShow.filters.blendTrans.Apply()
}
document.images.SlideShow.src = preLoad[j].src
if (document.all){
document.images.SlideShow.filters.blendTrans.Play()
}
j = j + 1
if (j > (p-1)) j=0
t = setTimeout('runSlideShow()', slideShowSpeed)
}
//-->
      </script>
      <table align="right" border="0" cellpadding="0" cellspacing="0">

        <tbody>
          <tr>

            <td rowspan="4"><img src="/images/pcm_spacer.gif" height="1" width="10"></td>

            <td rowspan="3" class="splashotBG"><img src="/images/pcm_spacer.gif" height="1" width="2"></td>

            <td class="splashotBG" align="center" height="30">SLIDESHOW (8)</td>

            <td rowspan="3" class="splashotBG"><img src="/images/pcm_spacer.gif" height="1" width="2"></td>

          </tr>

          <tr>

            <td class="splashotBG" align="center"><a href="http://www.pcmag.com/slideshow/0,1206,l=177839&amp;s=25308&amp;a=177827,00.asp"><img src="134534" name="SlideShow" border="0" height="85" width="85"></a></td>

          </tr>

          <tr>

            <td class="splashotBG" align="center" height="25">
            <a href="http://www.pcmag.com/slideshow_viewer/0,1205,l=177839&amp;p=1&amp;s=25308&amp;a=177827&amp;po=1&amp;i=1,00.asp" class="splashotDeck">Slideshow</a> <span class="splashotDeck">|</span>
            <a href="http://www.pcmag.com/slideshow/0,1206,l=177839&amp;s=25308&amp;a=177827,00.asp" class="splashotDeck">All Shots</a></td>

          </tr>

          <tr>

            <td colspan="3"><img src="/images/pcm_spacer.gif" height="10" width="1"></td>

          </tr>

        </tbody>
      </table>

      <script>
runSlideShow();
      </script>
<!-- zm_cda_
What is this page about?<br-->
      <br>

Our aim is to develop a <span style="font-weight: bold;">CAN
bus
(J1939) - RS232</span> (later, USB) analyzer, and to learn
about CAN and J1939 in the process, using the most crude (or free, or
cheap) tools
available...<br>

If something useful comes out of it, the better. <br>

      <br>

      <hr style="width: 100%; height: 2px;"><br>

      <div style="margin-left: 40px;"><small>Please
let me know
of any broken links, missing
parts etc. you may find here.<br>

Next issues will become more
sophisticated - I hope!.<br>

      <br>

      </small>
      <table style="width: 90%;" border="0" cellpadding="2" cellspacing="2">

        <tbody>

          <tr>

            <td style="background-color: rgb(224, 224, 224);">Don't
want to miss the next chapter? just drop me
an email to <span style="font-weight: bold;">recursos.pt@gmail.com</span>
subject: J1939 CAN, and I will notify you.<br>

No other use will be made of your e-mail address.</td>

          </tr>

        </tbody>
      </table>

      <br>

      <small><br>

      <span class="highlite">I am afraid my english sucks!
if you feel like editing this text, making it
more palatable, please contact me!</span><br>

      </small></div>

      <center>
      <table style="width: 60%;">

        <tbody>

          <tr>

            <td style="vertical-align: top;"><a href="http://www.langa.com/newsletter.htm" target="_blank"><img src="http://www.langa.com/images/langa0.jpg" border="1" height="35" width="125"></a><small> <b><a href="http://www.langa.com/newsletter.htm" target="_blank">CLICK</a>
to
sign up for<br>

Fred Langa's award-winning e-newsletter. You'll see how to get LOTS
more from
your hardware, software, and time online!</b></small> </td>

            <td> <br>

            <div align="center"><a href="http://www.flowerdeliverydeals.com/"><img alt="Send Flowers" src="http://c4.amazingcounters.com/counter.php?i=890627&amp;c=2672194" border="0"></a><br>

            <small><br>

            <a href="http://www.amazingcounters.com/"><font color="#999999">Free Hit Counter</font></a><br>

            </small> </div>

            </td>

          </tr>

        </tbody>
      </table>

      </center>

      <div style="text-align: left;">
      <hr style="width: 100%; height: 2px;"><a style="font-weight: bold;" href="index_7.html">Chapter
7</a><span style="font-weight: bold;"> </span>+
      <a style="font-weight: bold;" href="index_8.html">Chapter
8</a> (<span style="font-weight: bold;">on line
2006-May-04</span>) <img style="width: 30px; height: 10px;" alt="new material" title="new material since your last visit" src="images/new.gif"><br>

      <br>

After too much time playing with the simulation software(s), and having
become familiar with the basic <span style="font-weight: bold;">NMT</span>
procedures of <span style="font-weight: bold;">J1939</span>,
it downed on me that Microchip's provided <a href="http://ww1.microchip.com/downloads/en/AppNotes/J1939.zip">source
code</a> <img style="width: 15px; height: 16px;" alt="zip" src="images/zip.gif"> for <a href="http://ww1.microchip.com/downloads/en/AppNotes/00930a.pdf">J1939.c
CAN library</a> <img style="width: 16px; height: 16px;" alt="pdf" src="images/pdf.gif"> has a nasty bug.<br>

      <br>

Not only that, but also Vector's <span style="font-weight: bold;">CANoe</span>
CAPL code for their <span style="font-weight: bold;">AddressClaiming_CN.cfg</span>
sample, much touted by myself in&nbsp;<a href="index_5.html">Chapter
5</a> suffers exactly the same bug!<br>

      <br>

      <div style="text-align: center;"><img style="width: 337px; height: 144px;" alt="debug configuration" title="debug configuration" src="images/chapt_7/2_pic_can_small.png"><br>

      <br>

      <img style="width: 330px; height: 239px;" alt="Trace CannotClaimAddress" title="Trace CannotClaimAddress" src="images/chapter_8/trace_cannotclaim_small.png"><br>

      </div>

      <hr style="width: 100%; height: 2px;"><a style="font-weight: bold;" href="index_6.html">Chapter
6</a><span style="font-weight: bold;"> </span>(<span style="font-weight: bold;">on line 2006-April-27</span>)&nbsp;<br>

      <br>

This time we play with the second <span style="font-weight: bold;">CAN/J1939
simulator</span>, Michael Eisele's <span style="font-weight: bold;">Xtm</span>.<br>

In a very small foot-print <span style="font-weight: bold;">Xtm</span>
implements much of the simulation features we have already played with.<br>

      <br>

      <div style="text-align: center;"><img style="width: 427px; height: 238px;" alt="Xtm trace" title="Xtm trace" src="images/chapt_6/trace2_small.png"><br>

      </div>

      <br>

Again we have a look at the NMT Address Claim process, simulating 2
address conflits, each one with a different outcome.<br>

      <hr style="width: 100%; height: 2px;"><br>

      <br>

      <a style="font-weight: bold;" href="index_5.html">Chapter
5</a><span style="font-weight: bold;"> </span>(<span style="font-weight: bold;">on line 2006-March-29</span>)<br>

      <br>

Who needs a <span style="font-weight: bold;">CAN/J1939
simulator</span>? Well, if you are learning <span style="font-weight: bold;">CAN/J1939</span>
surely you can use it, among others, to test if the <span style="font-weight: bold;">NMT</span> behaviour
(network management) you have coded and believe is OK, is indeed
conforming to the SAE standard.<br>

CANoe simulator is a wonderful tool for that, and on top of
its price can't be beaten (yes, the limited but functional demo is
free). <br>

It does a lot more than what we need or can understand (!), but let us
have
a look at just a small parcel of it.<br>

      <br>

      <div style="text-align: center;"> (Notice: Address
Claiming CAPL code has a nasty bug, please read <a href="index_8.html">Chapter 8</a>)<br>

      </div>

      <br>

      <div align="center"> <img style="width: 452px; height: 202px;" alt="NMT trace window" title="NMT trace window" src="images/chapt_5/node3_capl_small.png"></div>

      <br>

&nbsp;
      <hr style="width: 100%; height: 2px;"><a style="font-weight: bold;" href="index_4.html">Chapter
4</a><span style="font-weight: bold;"> </span>(<span style="font-weight: bold;">on line 2006-March-16</span>)&nbsp;<br>

      <br>

The
firmware we have been using (J1939.c CAN library, Microchip's AN930) is
just doing Address Claiming and sending a "toggle LED" command. Not
terribly exciting!<br>

So we want to improve it, but that means
going deeper into understanding the <span style="font-weight: bold;">SAE
J1939 protocol</span> (automotive, commercial vehicles, etc.).<br>

We
could use some help in that, and luckily there are at least 2 free
"demos" available which we can use.<br>

      <br>

      <div style="text-align: center;"><img style="width: 218px; height: 178px;" alt="CANoe setup window" title="CANoe setup window (simulation)" src="images/canoe-setup-small.png"> <img style="width: 160px; height: 178px;" alt="CANoe panels window" title="CANoe panels window" src="images/canoe-panels-small.png"></div>

      </div>

      <hr style="width: 100%; height: 2px;"><a style="font-weight: bold;" href="index_3.html">Chapter
3</a><span style="font-weight: bold;"> </span>(<span style="font-weight: bold;">on line 2006-March-06</span>)&nbsp;<br>

      <br>

A very modest modification to the CAN-Uart #130 device code,
to place it in <span style="font-weight: bold;">ListenOnly</span>
mode, and with all <span style="font-weight: bold;">masks
set to 00</span>s, to allow any and all messages in - not just
the ones addressed to the device.<br>

      <br>

Yes,
it works - now we can se all messages; not a lot of fun, because there
are not that many messages to see... should we plug the thing into an
OBD2 connector?<br>

Well, not yet there.<br>

      <br>

      <hr style="width: 100%; height: 2px;">
      <h4><a href="index_2.html">Chapter 2</a>
(on line 2006-Feb-21)</h4>

Now
we became more ambitious: we want to spy the CAN bus traffic and log
it to our PC's screen so that we can leisurely study it (we like things
that difficult:=).<br>

      <br>

After much head scratching, we hit upon this:
let us keep the 2 nodes #128 and #129 exchanging messages, and add a
3rd
node, #130, listening to them, and reporting to the PC.<br>

      <br>

      <div style="text-align: center;"><img title="The UART is sending CAN buffers of messages addressed to him" style="width: 353px; height: 291px;" alt="3 PIC effort" src="images/3_pic_effort_pc.png"><br>

      </div>

      <div style="text-align: center;"><br>

      </div>

So we
moved the UARTIntC.c code to a third device, node #130, and now we are
indeed dumping the CAN buffer registers to the PC, but with a heavy
limitation: our "spy" only sees messages addressed to himself.<br>

OK, our next improvement is coming soon.<br>

      <br>

      <hr style="width: 100%; height: 2px;">
      <h4><a title="skip this and go to Chapter 2!" href="index_1.html">Chapter
1</a> (on line
2006-Feb-14)</h4>

Microchip's&nbsp;<a href="http://ww1.microchip.com/downloads/en/AppNotes/J1939.zip">source
code</a> <img style="width: 15px; height: 16px;" alt="zip" src="images/zip.gif"> for <a href="http://ww1.microchip.com/downloads/en/AppNotes/00930a.pdf">J1939.c
CAN library</a> <img style="width: 16px; height: 16px;" alt="pdf" src="images/pdf.gif"> (Kim
Otten et al.), plus Application Maestro generated
code&nbsp;UARTIntC.c, were used to implement a bare-bones system
with a 2-node CAN bus.<br>

      <br>

      <div style="text-align: center;"> (Notice: Address
Claiming code has a nasty bug, please read <a href="index_7.html">Chapter
7</a>)<br>

      </div>

      <br>

Node #129 upon receiving commands from
#128&nbsp;toggles a LED and also outputs strings "<span style="font-weight: bold;">ON</span>" and "<span style="font-weight: bold;">OFF</span>"
thru the RSR23 to the PC.<br>

      <br>

      <div style="text-align: center;"><img title="The UART is not sending CAN buffers, just &quot;ON&quot; or &quot;OFF&quot; strings" style="width: 340px; height: 223px;" alt="the 2 PIC effort" src="images/2_pic_effort_pc.png"><br>

      </div>

In this first effort we were not reading the CAN buffers, rather just
making sure that our UART was working embedded in the same PIC with the
CAN firmware.<br>

      <br>

      <hr style="width: 100%; height: 2px;"><br>

      <a href="mailto:recursos.pt@gmail.com">&copy;Rec</a>
&nbsp;(recursos.pt@gmail.com) <br>

2006-05-05<br>

      <br>

      </td>

    </tr>

  </tbody>
</table>

<br>

<br>

</body>
</html>
